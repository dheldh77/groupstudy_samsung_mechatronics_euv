# Chapter 05. ìŠ¤í”„ë§ ì‹œíë¦¬í‹°ì™€ OAuth 2.0ìœ¼ë¡œ ë¡œê·¸ì¸ ê¸°ëŠ¥ êµ¬í˜„í•˜ê¸°

- ìŠ¤í”„ë§ ì‹œíë¦¬í‹°ëŠ” ë§‰ê°•í•œ ì¸ì¦(Authentication)ê³¼ ì¸ê°€(Authorization) ê¸°ëŠ¥ì„ ê°€ì§„ í”„ë ˆì„ ì›Œí¬
- ìŠ¤í”„ë§ ê¸°ë°˜ì˜ ì• í”Œë¦¬ì¼€ì´ì…˜ì—ì„œëŠ” ë³´ì•ˆì„ ìœ„í•œ í‘œì¤€

> ì¸ì¦(Authentication)ê³¼ ì¸ê°€(Authorization)
> 
- â€˜ì¸ì¦â€™ì€ ì‚¬ìš©ìê°€ ëˆ„êµ¬ì¸ì§€ í™•ì¸í•˜ëŠ” ì ˆì°¨
- â€˜ì¸ê°€'ëŠ” ì‚¬ìš©ìì— ëŒ€í•œ ê¶Œí•œì„ í—ˆë½í•˜ëŠ” ê²ƒ

## 5.1 ìŠ¤í”„ë§ ì‹œíë¦¬í‹°ì™€ ìŠ¤í”„ë§ ì‹œíë¦¬í‹° Oauth2 í´ë¼ì´ì–¸íŠ¸

- ë§ì€ ì„œë¹„ìŠ¤ì—ì„œ ë¡œê·¸ì¸ ê¸°ëŠ¥ì„ ì†Œì…œ ë¡œê·¸ì¸ ê¸°ëŠ¥ì„ ì‚¬ìš©
- ì§ì ‘ êµ¬í˜„í•˜ëŠ” ë¶ˆí¸í•¨ì„ ì¤„ì´ê¸° ìœ„í•¨ (ë¡œê·¸ì¸ ì‹œ ë³´ì•ˆ, íšŒì›ê°€ì… ì‹œ ì´ë©”ì¼/ì „í™”ë²ˆí˜¸ ì¸ì¦, ë¹„ë°€ë²ˆí˜¸ ì°¾ê¸° ë“±)

> ìŠ¤í”„ë§ ë¶€íŠ¸ 1.5 vs ìŠ¤í”„ë§ ë¶€íŠ¸ 2.0
> 
- ìŠ¤í”„ë§ ë¶€íŠ¸ 1.5ì™€ 2.0ì˜ OAuth2 ì—°ë™ ë°©ì‹ì´ ë§ì´ ë³€í•¨
- â€˜spring-security-oauth2-autoconfigureâ€™ ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ì‚¬ìš©í•˜ë©´ ì„¤ì • ë°©ë²•ì— í° ì°¨ì´ê°€ ì—†ìŒ

í•˜ì§€ë§Œ, ë³¸ ì±…ì—ì„œëŠ” Spring Security Oauth2 Clientë¥¼ ì‚¬ìš©í•˜ëŠ”ë° ì´ìœ ëŠ” ì•„ë˜ì™€ ê°™ìŒ

- ìŠ¤í”„ë§ íŒ€ì—ì„œ ê¸°ì¡´ 1.5ì—ì„œ ì‚¬ìš©ë˜ë˜ spring-security-oauth í”„ë¡œì íŠ¸ëŠ” ìœ ì§€ ìƒíƒœë¡œ ê²°ì •í•˜ê³ , ì‹ ê·œ ê¸°ëŠ¥ì€ ìƒˆ oauth2 ë¼ì´ë¸ŒëŸ¬ë¦¬ì—ì„œë§Œ ì§€ì›í•˜ê² ë‹¤ê³  ì„ ì–¸
- ìŠ¤í”„ë§ ë¶€íŠ¸ìš© ë¼ì´ë¸ŒëŸ¬ë¦¬(starter) ì¶œì‹œ
- ê¸°ì¡´ì— ì‚¬ìš©ë˜ë˜ ë°©ì‹ì€ í™•ì¥ í¬ì¸íŠ¸ê°€ ì ì ˆí•˜ê²Œ ì˜¤í”ˆë˜ì–´ ìˆì§€ ì•Šì•„ ì§ì ‘ ìƒì†í•˜ê±°ë‚˜ ì˜¤ë²„ë¼ì´ë”© í•´ì•¼ í•˜ê³  ì‹ ê·œ ë¼ì´ë¸ŒëŸ¬ë¦¬ì˜ ê²½ìš° í™•ì¥ í¬ì¸íŠ¸ë¥¼ ê³ ë ¤í•´ì„œ ì„¤ê³„ëœ ìƒíƒœ

> application.yml íŒŒì¼ ì°¨ì´
> 

```yaml
google:
  client:
    clientId : 
    clientSecret: 
    accessTokenUri: 
    userAuthorizationUri:
    clientAuthenticationScheme:
    scope:
  resource:
    userInfoUri:
```

```yaml
spring:
  security:
    oauth2:
      client:
        clientId:
        clientSecret:
```

- 2.0 ë°©ì‹ì—ì„œëŠ” client ì¸ì¦ ì •ë³´ë§Œ ì…ë ¥
- ë‹¤ë¥¸ ê°’ë“¤ì€ enumìœ¼ë¡œ ëŒ€ì²´

## 5.2 êµ¬ê¸€ ì„œë¹„ìŠ¤ ë“±ë¡

> .gitignore ë“±ë¡ ì—ëŸ¬
> 
- gitignoreì— ë“±ë¡í–ˆëŠ”ë°, Intellijì—ì„œ commití•  ë•Œ ìë™ í¬í•¨ë¨

## 5.3 êµ¬ê¸€ ë¡œê·¸ì¸ ì—°ë™í•˜ê¸°

> csrf ê´€ë ¨
> 
- csrfì— ëŒ€í•œ ì •ì˜ë¥¼ ì•Œê³  ë„˜ì–´ê°€ì

> db ì ìš© ê´€ë ¨
> 
- db ê°’ ë³€ê²½í•˜ê³  ë°”ë¡œ ì§„í–‰í–ˆì„ ë•Œ, ì ìš©ì•ˆë˜ëŠ” ë¬¸ì œ

## 5.4 ì–´ë…¸í…Œì´ì…˜ ê¸°ë°˜ìœ¼ë¡œ ê°œì„ í•˜ê¸°

## 5.5 ì„¸ì…˜ ì €ì¥ì†Œë¡œ ë°ì´í„°ë² ì´ìŠ¤ ì‚¬ìš©í•˜ê¸°

> yml íŒŒì¼ì— ì ìš©
> 

```yaml
spring:
  session:
    store-type: jdbc
```

## 5.6 ë„¤ì´ë²„ ë¡œê·¸ì¸

> yml íŒŒì¼ì— ì ìš©
> 

```yaml
spring:
  security:
    oauth2:
      client:
        registration:
          naver:
            client-id: 
            client-secret: 
            redirect-uri: "{baseUrl}/{action}/oauth2/code/{registrationId}"
            authorization-grant-type: authorization_code
            scope: name, email, profile_image
            client-name: Naver
        provider:
          naver:
            authorization-uri: https://nid.naver.com/oauth2.0/authorize
            token-uri: https://nid.naver.com/oauth2.0/token
            user-info-uri: https://openapi.naver.com/v1/nid/me
#            ê¸°ì¤€ì´ ë˜ëŠ” user_nameì˜ ì´ë¦„ì„ ë„¤ì´ë²„ì—ì„œëŠ” responseë¡œ í•´ì•¼í•¨ (ë„¤ì´ë²„ì˜ íšŒì› ì¡°íšŒ ì‹œ ë°˜í™˜ë˜ëŠ” JSON í˜•íƒœ ë–„ë¬¸)
            user-name-attribute: response
```

## 5.7 ê¸°ì¡´ í…ŒìŠ¤íŠ¸ì— ì‹œíë¦¬í‹° ì ìš©í•˜ê¸°

```java
		@Test
    @WithMockUser(roles="USER")
    public void Posts_regist() throws Exception {
        // given
        String title = "title";
        String content = "content";

        PostsSaveRequestDto requestDto = PostsSaveRequestDto.builder()
                .title(title)
                .content(content)
                .author("author")
                .build();
        String url = "http://localhost:" + port + "/api/v1/posts";

        // when
//        ResponseEntity<Long> responseEntity = restTemplate.postForEntity(url, requestDto, Long.class);
        // mvc.perform
        // - ìƒì„±ëœ MockMvcë¥¼ í†µí•´ APIë¥¼ í…ŒìŠ¤íŠ¸
        // - ë³¸ë¬¸(Body) ì˜ì—­ì€ ë¬¸ìì—´ë¡œ í‘œí˜„í•˜ê¸° ìœ„í•´ ObjectMapperë¥¼ í†µí•´ ë¬¸ìì—´ì„ JSONìœ¼ë¡œ ë³€í™˜
        mvc.perform(post(url)
                .contentType(MediaType.APPLICATION_JSON_UTF8)
                .content(new ObjectMapper().writeValueAsString(requestDto)))
                .andExpect(status().isOk());

        // then
//        assertThat(responseEntity.getStatusCode()).isEqualTo(HttpStatus.OK);
//        assertThat(responseEntity.getBody()).isGreaterThan(0L);

        List<Posts> all = postsRepository.findAll();
        assertThat(all.get(0).getTitle()).isEqualTo(title);
        assertThat(all.get(0).getContent()).isEqualTo(content);
    }

		@Test
    @WithMockUser(roles = "USER")
    public void Posts_update() throws Exception {
        // given
        Posts savedPosts = postsRepository.save(Posts.builder()
                .title("title")
                .content("content")
                .author("author")
                .build());

        Long updateId = savedPosts.getId();
        String expectedTitle = "title2";
        String expectedContent = "content2";

        PostsUpdateRequestDto requestDto = PostsUpdateRequestDto.builder()
                .title(expectedTitle)
                .content(expectedContent)
                .build();

        String url = "http://localhost:" + port + "/api/v1/posts/" + updateId;

        HttpEntity<PostsUpdateRequestDto> requestEntity = new HttpEntity<>(requestDto);

        // when
//        ResponseEntity<Long> responseEntity = restTemplate.exchange(url, HttpMethod.PUT, requestEntity, Long.class);
        mvc.perform(put(url)
                .contentType(MediaType.APPLICATION_JSON_UTF8)
                .content(new ObjectMapper().writeValueAsString(requestDto)))
                .andExpect(status().isOk());

        // then
//        assertThat(responseEntity.getStatusCode()).isEqualTo(HttpStatus.OK);
//        assertThat(responseEntity.getBody()).isGreaterThan(0L);

        List<Posts> all = postsRepository.findAll();
        assertThat(all.get(0).getTitle()).isEqualTo(expectedTitle);
        assertThat(all.get(0).getContent()).isEqualTo(expectedContent);
    }
```

- ê¸°ì¡´ í…ŒìŠ¤íŠ¸ì— ì‚¬ìš©í–ˆë˜ ResponseEntityì„ ê·¸ëŒ€ë¡œ ë‘˜ ê²½ìš°ì— ì˜¤ë¥˜ ë°œìƒ

# ğŸ“˜ Reference
- [REST](https://dheldh77.tistory.com/entry/%EB%84%A4%ED%8A%B8%EC%9B%8C%ED%81%AC-RESTRepresentational-State-Transfer)
- [REST vs SOAP](https://dheldh77.tistory.com/entry/%EB%84%A4%ED%8A%B8%EC%9B%8C%ED%81%AC-SOAP%EC%99%80-REST)
